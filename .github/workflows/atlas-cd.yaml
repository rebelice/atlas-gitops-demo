name: Atlas CD
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: read

jobs:
  # Stage 1: Generate accumulated plan and show diff
  plan:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.diff.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Atlas
        uses: ariga/setup-atlas@v0
        with:
          cloud-token: ${{ secrets.ATLAS_CLOUD_TOKEN }}

      - name: Calculate Schema Diff
        id: diff
        run: |
          echo "### Schema Diff for ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Calculate diff between prod database and desired schema
          DIFF_OUTPUT=$(atlas schema diff \
            --dev-url "docker://postgres/15/dev?search_path=public" \
            --from "${{ secrets.PROD_DB_URL }}" \
            --to "file://schema.hcl" \
            2>&1) || true

          if [ -z "$DIFF_OUTPUT" ] || echo "$DIFF_OUTPUT" | grep -q "Schemas are synced"; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… **No schema changes detected.** Database is already in sync." >> $GITHUB_STEP_SUMMARY
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "#### SQL to be executed:" >> $GITHUB_STEP_SUMMARY
            echo '```sql' >> $GITHUB_STEP_SUMMARY
            echo "$DIFF_OUTPUT" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â³ **Waiting for approval to deploy...**" >> $GITHUB_STEP_SUMMARY
          fi
        env:
          ATLAS_CLOUD_TOKEN: ${{ secrets.ATLAS_CLOUD_TOKEN }}

  # Stage 2: Deploy after manual approval
  deploy:
    needs: plan
    if: needs.plan.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Setup Atlas
        uses: ariga/setup-atlas@v0
        with:
          cloud-token: ${{ secrets.ATLAS_CLOUD_TOKEN }}

      - name: Apply Schema to Production
        run: |
          echo "### Deployment to Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Approved by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Apply schema changes to production database
          atlas schema apply \
            --dev-url "docker://postgres/15/dev?search_path=public" \
            --url "${{ secrets.PROD_DB_URL }}" \
            --to "file://schema.hcl" \
            --auto-approve

          echo "âœ… **Schema applied successfully!**" >> $GITHUB_STEP_SUMMARY
        env:
          ATLAS_CLOUD_TOKEN: ${{ secrets.ATLAS_CLOUD_TOKEN }}

      - name: Push Schema to Registry
        run: |
          # Update registry with the new schema state
          atlas schema push --env ci --tag ${{ github.ref_name }}
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Schema pushed to registry with tag: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        env:
          ATLAS_CLOUD_TOKEN: ${{ secrets.ATLAS_CLOUD_TOKEN }}

  # Stage 3: Skip deployment if no changes
  skip:
    needs: plan
    if: needs.plan.outputs.has_changes == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: No Deployment Needed
        run: |
          echo "### No Deployment Needed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Database schema is already in sync with the desired state." >> $GITHUB_STEP_SUMMARY
          echo "Tag **${{ github.ref_name }}** recorded but no changes applied." >> $GITHUB_STEP_SUMMARY
